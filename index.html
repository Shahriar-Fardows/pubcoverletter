<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Assignment Cover Page Generator</title>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-7ZV70MZE13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-7ZV70MZE13');
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
      @page {
          size: A4;
          margin: 0;
      }
      
      .a4-page {
          width: 210mm;
          height: 297mm;
          margin: 0 auto;
          background: white;
          position: relative;
      }

      .page-content {
          border: 2px dashed #9ca3af;
          margin: 8mm;
          height: 277mm;
          position: relative;
      }

      @media print {
          html, body {
              width: 100%;
              height: 100%;
              margin: 0;
              padding: 0;
              background: white;
          }
          .no-print {
              display: none !important;
          }
          .a4-page {
              margin: 0;
              padding: 0;
              box-shadow: none !important;
              width: 100%;
              height: 100%;
          }
          .page-content {
              border: 2px dashed #9ca3af !important; /* Keep the border visible when printing */
              margin: 8mm !important;
              height: calc(100% - 16mm) !important;
              width: calc(100% - 16mm) !important;
          }
          .content-wrapper {
              height: 100% !important;
          }
          .navbar {
              display: none !important;
          }
      }

      .form-container {
          max-width: 210mm;
          margin: 2rem auto;
      }
  </style>
</head>
<body class="bg-gray-100">
   <nav class="bg-white shadow-md navbar">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex justify-between h-16">
              <!-- Logo and site name -->
              <div class="flex items-center">
                  <div class="flex-shrink-0 flex items-center">
                      <span class="text-blue-600 font-bold text-xl">Academic Tools</span>
                  </div>
              </div>
              
              <!-- Desktop menu -->
              <div class="hidden md:flex md:items-center md:space-x-6">
                  <a href="https://pubfees.netlify.app/" class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200">
                      Semester Fee Calculator
                  </a>
                  <a href="https://pubcoverletter.netlify.app/" class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200">
                      Cover Page Generator
                  </a>
                  <a href="https://pubadvisor.netlify.app/" class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200">
                      Academic Advisor
                  </a>
              </div>
              
              <!-- Mobile menu button -->
              <div class="flex md:hidden items-center">
                  <button id="mobile-menu-button" class="inline-flex items-center justify-center p-2 rounded-md text-gray-700 hover:text-blue-600 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500">
                      <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                      </svg>
                  </button>
              </div>
          </div>
      </div>

      <!-- Mobile menu, show/hide based on menu state -->
      <div id="mobile-menu" class="md:hidden hidden">
          <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
              <a href="https://pubfees.netlify.app/" class="block text-gray-700 hover:text-blue-600 hover:bg-gray-50 px-3 py-2 rounded-md text-base font-medium">
                  Semester Fee Calculator
              </a>
              <a href="https://pubcoverletter.netlify.app/" class="block text-gray-700 hover:text-blue-600 hover:bg-gray-50 px-3 py-2 rounded-md text-base font-medium">
                  Cover Page Generator
              </a>
              <a href="https://pubadvisor.netlify.app/" class="block text-gray-700 hover:text-blue-600 hover:bg-gray-50 px-3 py-2 rounded-md text-base font-medium">
                  Academic Advisor
              </a>
          </div>
      </div>
  </nav>

  
  <!-- Form Section -->
  <div class="form-container no-print bg-white p-6 rounded-lg shadow-md">
      <h2 class="text-2xl font-bold mb-4 text-center">Assignment Cover Page Generator</h2>
      <form id="coverPageForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- New field for assignment title -->
          <div class="md:col-span-2">
              <label for="assignmentTitle" class="block text-sm font-medium text-gray-700 mb-1">Assignment Title:</label>
              <input type="text" id="assignmentTitle" class="w-full p-2 border border-gray-300 rounded" value="ASSIGNMENT">
              <p class="text-xs text-gray-500 mt-1">This text will appear as the title of your cover page</p>
          </div>
          
          <div>
              <label for="courseName" class="block text-sm font-medium text-gray-700 mb-1">Course Name:</label>
              <input type="text" id="courseName" class="w-full p-2 border border-gray-300 rounded" value="Calculus I">
          </div>
          <div>
              <label for="courseCode" class="block text-sm font-medium text-gray-700 mb-1">Course Code:</label>
              <input type="text" id="courseCode" class="w-full p-2 border border-gray-300 rounded">
          </div>
          <div>
              <label for="submissionDate" class="block text-sm font-medium text-gray-700 mb-1">Submission Date:</label>
              <input type="date" id="submissionDate" class="w-full p-2 border border-gray-300 rounded">
              <div class="mt-1">
                  <label class="inline-flex items-center">
                      <input type="checkbox" id="noSubmissionDate" class="form-checkbox">
                      <span class="ml-2 text-sm text-gray-600">Leave blank</span>
                  </label>
              </div>
          </div>
          <div>
              <label for="studentName" class="block text-sm font-medium text-gray-700 mb-1">Student Name:</label>
              <input type="text" id="studentName" class="w-full p-2 border border-gray-300 rounded">
          </div>
          <div>
              <label for="studentId" class="block text-sm font-medium text-gray-700 mb-1">Student ID:</label>
              <input type="text" id="studentId" class="w-full p-2 border border-gray-300 rounded">
          </div>
          <div>
              <label for="section" class="block text-sm font-medium text-gray-700 mb-1">Section:</label>
              <input type="text" id="section" class="w-full p-2 border border-gray-300 rounded">
          </div>
          <div>
              <label for="teacherName" class="block text-sm font-medium text-gray-700 mb-1">Teacher Name:</label>
              <input type="text" id="teacherName" class="w-full p-2 border border-gray-300 rounded">
          </div>
          <div>
              <label for="teacherPosition" class="block text-sm font-medium text-gray-700 mb-1">Teacher Position:</label>
              <input type="text" id="teacherPosition" class="w-full p-2 border border-gray-300 rounded" value="Lecturer">
          </div>
          <div>
              <label for="department" class="block text-sm font-medium text-gray-700 mb-1">Department:</label>
              <input type="text" id="department" class="w-full p-2 border border-gray-300 rounded" 
                     value="Computer Science and Engineering" 
                     placeholder="Computer Science and Engineering">
          </div>
          <div class="md:col-span-2 flex justify-center gap-4 mt-4">
              <button type="button" id="previewButton" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">
                  Preview
              </button>
              <button type="button" id="printButton" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                  Print Cover Page
              </button>
          </div>
      </form>
  </div>

  <!-- A4 Page Preview -->
  <div id="coverPagePreview" class="a4-page shadow-lg">
      <div class="page-content">
          <div class="content-wrapper flex flex-col justify-between h-full py-12 px-8">
              <!-- Previous top and middle sections remain same -->
              <div class="space-y-8">
                  <!-- University Logo -->
                  <div class="flex justify-center">
                      <img src="https://lh6.googleusercontent.com/proxy/224_BoPKg5YSQ0Vvv-TaiDYObz3338Yq2oyZz89fHfnK-NysLi3kuMLE1YVdY68C_NT-pWLbQ05z1bUJaRQj" 
                           alt="Presidency University Logo" 
                           class="h-28 object-contain">
                  </div>

                  <!-- Assignment Title - Now using dynamic content -->
                  <div class="text-center">
                      <h1 class="text-3xl font-bold underline" id="displayAssignmentTitle">ASSIGNMENT</h1>
                  </div>

                  <!-- Course Information -->
                  <div class="space-y-3 text-center">
                      <p class="text-xl"><span class="font-semibold">Course Name:</span> <span id="displayCourseName">Calculus I</span></p>
                      <p class="text-xl"><span class="font-semibold">Course code:</span> <span id="displayCourseCode">MAT123</span></p>
                      <p class="text-xl"><span class="font-semibold">Submission Date:</span> <span id="displaySubmissionDate">22/02/2025</span></p>
                  </div>
              </div>

              <!-- Middle Section -->
              <div class="space-y-12">
                  <!-- Submitted by Section -->
                  <div class="text-center space-y-2">
                      <p class="text-xl italic mb-3">Submitted by</p>
                      <p class="text-xl font-bold" id="displayStudentName">JANNATUN NAEEM</p>
                      <p class="text-xl"><span class="font-semibold">Student ID:</span> <span id="displayStudentId">242241038</span></p>
                      <p class="text-xl"><span class="font-semibold">Section:</span> <span id="displaySection">2</span></p>
                  </div>

                  <!-- Submitted to Section -->
                  <div class="text-center space-y-2">
                      <p class="text-xl italic mb-3">Submitted to</p>
                      <p class="text-xl font-bold" id="displayTeacherName">NAFIA MOLLIK</p>
                      <p class="text-xl" id="displayTeacherPosition">Lecturer</p>
                      <p class="text-xl">Presidency University</p>
                  </div>
              </div>

              <!-- Bottom Section -->
              <div class="text-center space-y-2">
                  <p class="text-xl">Department of <span id="displayDepartment">Computer Science and Engineering</span></p>
                  <p class="text-xl font-semibold">Presidency University</p>
              </div>
          </div>
      </div>
  </div>

  <script>

      // Toggle mobile menu
      const mobileMenuButton = document.getElementById('mobile-menu-button');
      const mobileMenu = document.getElementById('mobile-menu');
      
      mobileMenuButton.addEventListener('click', () => {
          mobileMenu.classList.toggle('hidden');
      });
      
      // SheetDB API endpoints
      const sheetDbApis = [
          'https://sheetdb.io/api/v1/j2l9m7ykx1dtt',
          'https://sheetdb.io/api/v1/5m1omtva8avsk',
          'https://sheetdb.io/api/v1/61kyqimj66opr',
          'https://sheetdb.io/api/v1/0lbjvqvqaht7u',
          'https://sheetdb.io/api/v1/y3v109nzuzvwf',
          'https://sheetdb.io/api/v1/xut3wtv9lzil4'
      ];
      
      // API usage tracking
      let apiUsageCounts = {};
      
      // Initialize API usage from localStorage if available
      function initializeApiUsage() {
          const savedUsage = localStorage.getItem('apiUsageCounts');
          if (savedUsage) {
              apiUsageCounts = JSON.parse(savedUsage);
          } else {
              // Initialize with zero counts
              sheetDbApis.forEach(api => {
                  apiUsageCounts[api] = 0;
              });
              saveApiUsage();
          }
      }
      
      // Save API usage to localStorage
      function saveApiUsage() {
          localStorage.setItem('apiUsageCounts', JSON.stringify(apiUsageCounts));
      }
      
      // Get next available API endpoint
      function getNextAvailableApi() {
          for (const api of sheetDbApis) {
              if (!apiUsageCounts[api] || apiUsageCounts[api] < 500) {
                  return api;
              }
          }
          // If all APIs have reached their limit, use the first one
          return sheetDbApis[0];
      }
      
      // Increment API usage count
      function incrementApiUsage(api) {
          if (!apiUsageCounts[api]) {
              apiUsageCounts[api] = 0;
          }
          apiUsageCounts[api]++;
          saveApiUsage();
      }
      
      // Reset API usage counts (e.g., at the beginning of a new month)
      function resetApiUsage() {
          sheetDbApis.forEach(api => {
              apiUsageCounts[api] = 0;
          });
          saveApiUsage();
      }
      
      // Function to log errors silently (only to console)
      function logError(message, error) {
          console.error(`[${new Date().toISOString()}] ${message}`, error);
          
          // Store errors in localStorage for debugging
          const errors = JSON.parse(localStorage.getItem('sheetDbErrors') || '[]');
          errors.push({
              timestamp: new Date().toISOString(),
              message: message,
              error: error.toString(),
              details: error.stack || 'No stack trace'
          });
          
          // Keep only the last 10 errors
          if (errors.length > 10) {
              errors.shift();
          }
          
          localStorage.setItem('sheetDbErrors', JSON.stringify(errors));
      }
      
      // Function to save data to Google Sheets via SheetDB
      async function saveToGoogleSheets() {
          try {
              const assignmentTitle = document.getElementById('assignmentTitle').value;
              const studentId = document.getElementById('studentId').value;
              const studentName = document.getElementById('studentName').value;
              const section = document.getElementById('section').value;
              const department = document.getElementById('department').value;
              const courseName = document.getElementById('courseName').value;
              const teacherName = document.getElementById('teacherName').value;
              
              // Create data object - FIXED: using studentName instead of name
              const data = {
                  assignmentTitle: assignmentTitle || 'ASSIGNMENT',
                  studentId: studentId || 'Not provided',
                  studentName: studentName || 'Not provided', // Changed from 'name' to 'studentName'
                  section: section || 'Not provided',
                  department: department || 'Computer Science and Engineering',
                  courseName: courseName || 'Not provided',
                  teacherName: teacherName || 'Not provided',
                  createDate: new Date().toLocaleDateString('en-GB') // Format as DD/MM/YYYY
              };
              
              // Get next available API
              const apiEndpoint = getNextAvailableApi();
              
              // Log the API being used and data being sent (for debugging)
              console.log(`Using API: ${apiEndpoint}`);
              console.log('Sending data:', data);
              
              // Send data to SheetDB (don't await the response)
              fetch(apiEndpoint, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ data: [data] })
              })
              .then(response => {
                  if (response.ok) {
                      // Increment API usage
                      incrementApiUsage(apiEndpoint);
                      console.log('Data saved successfully!');
                      return response.json();
                  } else {
                      return response.json().then(errorData => {
                          throw new Error(`API responded with status ${response.status}: ${JSON.stringify(errorData)}`);
                      });
                  }
              })
              .then(responseData => {
                  console.log('API response:', responseData);
              })
              .catch(error => {
                  logError('Error saving data to SheetDB', error);
                  
                  // Try the next API if this one failed
                  const currentIndex = sheetDbApis.indexOf(apiEndpoint);
                  if (currentIndex >= 0 && currentIndex < sheetDbApis.length - 1) {
                      const nextApi = sheetDbApis[currentIndex + 1];
                      console.log(`Retrying with next API: ${nextApi}`);
                      
                      // Retry with the next API
                      fetch(nextApi, {
                          method: 'POST',
                          headers: {
                              'Content-Type': 'application/json'
                          },
                          body: JSON.stringify({ data: [data] })
                      })
                      .then(response => {
                          if (response.ok) {
                              incrementApiUsage(nextApi);
                              console.log('Data saved successfully with backup API!');
                          } else {
                              throw new Error(`Backup API responded with status ${response.status}`);
                          }
                      })
                      .catch(backupError => {
                          logError('Error saving data with backup API', backupError);
                      });
                  }
              });
              
          } catch (error) {
              logError('Error in saveToGoogleSheets function', error);
          }
      }
      
      // Function to format date as DD/MM/YYYY
      function formatDate(dateString) {
          if (!dateString) return '';
          const date = new Date(dateString);
          return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
      }

      // Function to update the preview
      function updatePreview() {
          const assignmentTitle = document.getElementById('assignmentTitle').value || 'ASSIGNMENT';
          const courseName = document.getElementById('courseName').value || 'Calculus I';
          const courseCode = document.getElementById('courseCode').value || 'MAT123';
          const submissionDate = document.getElementById('submissionDate').value;
          const noSubmissionDate = document.getElementById('noSubmissionDate').checked;
          const studentName = document.getElementById('studentName').value || 'JANNATUN NAEEM';
          const studentId = document.getElementById('studentId').value || '242241038';
          const section = document.getElementById('section').value || '2';
          const teacherName = document.getElementById('teacherName').value || 'NAFIA MOLLIK';
          const teacherPosition = document.getElementById('teacherPosition').value || 'Lecturer';
          const department = document.getElementById('department').value || 'Computer Science and Engineering';

          // Update assignment title
          document.getElementById('displayAssignmentTitle').textContent = assignmentTitle;
          
          document.getElementById('displayCourseName').textContent = courseName;
          document.getElementById('displayCourseCode').textContent = courseCode;
          
          // Handle submission date display based on checkbox
          if (noSubmissionDate) {
              document.getElementById('displaySubmissionDate').textContent = '';
          } else {
              document.getElementById('displaySubmissionDate').textContent = submissionDate ? formatDate(submissionDate) : '22/02/2025';
          }
          
          document.getElementById('displayStudentName').textContent = studentName;
          document.getElementById('displayStudentId').textContent = studentId;
          document.getElementById('displaySection').textContent = section;
          document.getElementById('displayTeacherName').textContent = teacherName;
          document.getElementById('displayTeacherPosition').textContent = teacherPosition;
          document.getElementById('displayDepartment').textContent = department;
      }

      // Track form field changes for analytics
      function trackFormFieldChange(fieldName) {
          gtag('event', 'form_field_change', {
              'field_name': fieldName,
              'page_title': 'Cover Page Generator'
          });
      }

      // Add event listeners to form inputs
      document.querySelectorAll('#coverPageForm input').forEach(input => {
          input.addEventListener('input', updatePreview);
          input.addEventListener('change', updatePreview);
          
          // Add analytics tracking for form field changes
          input.addEventListener('change', function() {
              trackFormFieldChange(this.id);
          });
      });

      // Preview button functionality with analytics
      document.getElementById('previewButton').addEventListener('click', function() {
          // Track preview button click
          gtag('event', 'preview_cover_page', {
              'event_category': 'engagement',
              'event_label': 'Preview Cover Page'
          });
          
          document.getElementById('coverPagePreview').scrollIntoView({ behavior: 'smooth' });
      });

      // Change 1: Student ID Block System - Add API call before form submission
      // Add this code right before the print button click event listener
      
      // Replace the existing checkStudentIdBlocked function with this updated version
      // that handles the specific API response format

      // Function to check if student ID is blocked
      async function checkStudentIdBlocked(studentId) {
        try {
          const response = await fetch('https://script.google.com/macros/s/AKfycby6Rgtq0JQ6aeYY0whxxiHMD_jQGy73mqV3jg6nzDponKf65e0r5x93RSCTlPT4ZZsQow/exec');
          if (response.ok) {
            const responseData = await response.json();
            
            // Check if the API response has the expected structure
            if (responseData.status === "success" && Array.isArray(responseData.data)) {
              // Check if any student in the data array has a matching StudentId
              return responseData.data.some(student => 
                student.StudentId && student.StudentId.toString() === studentId.toString()
              );
            }
            return false;
          }
          return false;
        } catch (error) {
          console.error('Error checking student ID:', error);
          return false;
        }
      }
      
      // Function to disable all form fields
      function disableAllFormFields(disable) {
        // Disable all input fields
        document.querySelectorAll('#coverPageForm input, #coverPageForm select, #coverPageForm textarea').forEach(field => {
          field.disabled = disable;
        });
        
        // Disable buttons
        document.getElementById('printButton').disabled = disable;
        document.getElementById('previewButton').disabled = disable;
      }
      
      // Add event listener to student ID field to check for blocked IDs automatically
      document.getElementById('studentId').addEventListener('blur', async function() {
        const studentId = this.value.trim();
        if (studentId) {
          const isBlocked = await checkStudentIdBlocked(studentId);
          if (isBlocked) {
            disableAllFormFields(true);
          } else {
            disableAllFormFields(false);
          }
        }
      });
      
      // Modify the print button functionality to check for blocked IDs
      document.getElementById('printButton').addEventListener('click', async function() {
        const studentId = document.getElementById('studentId').value.trim();
        
        // Check if student ID is blocked
        if (studentId) {
          const isBlocked = await checkStudentIdBlocked(studentId);
          
          if (isBlocked) {
            disableAllFormFields(true);
            return;
          }
        }
        
        // If not blocked, continue with normal functionality
        saveToGoogleSheets();
        
        gtag('event', 'generate_cover_page', {
          'event_category': 'conversion',
          'event_label': 'Print Cover Page'
        });
        
        window.print();
      });
      
      // Print button functionality with analytics and silent data saving
      

      // Set today's date as default
      const today = new Date();
      const formattedDate = today.toISOString().substr(0, 10);
      document.getElementById('submissionDate').value = formattedDate;
      
      // Track page load
      gtag('event', 'page_view', {
          page_title: 'Assignment Cover Page Generator',
          page_location: window.location.href,
          page_path: window.location.pathname
      });
      
      // Initialize API usage tracking
      initializeApiUsage();
      
      // Check if it's a new month to reset API usage
      function checkAndResetMonthlyUsage() {
          const lastResetDate = localStorage.getItem('lastApiResetDate');
          const currentDate = new Date();
          const currentMonth = currentDate.getMonth();
          const currentYear = currentDate.getFullYear();
          
          if (lastResetDate) {
              const resetDate = new Date(lastResetDate);
              const resetMonth = resetDate.getMonth();
              const resetYear = resetDate.getFullYear();
              
              // If it's a new month, reset the API usage
              if (currentMonth !== resetMonth || currentYear !== resetYear) {
                  resetApiUsage();
                  localStorage.setItem('lastApiResetDate', currentDate.toISOString());
              }
          } else {
              // First time running, set the reset date
              localStorage.setItem('lastApiResetDate', currentDate.toISOString());
          }
      }
      
      // Check for monthly reset on page load
      checkAndResetMonthlyUsage();
      
      // Initial update
      updatePreview();
  </script>
</body>
</html>
